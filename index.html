<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIPLOMATIC HUB - PARTY MODE</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="app" class="container">
        <h1 class="gold-text">DIPLOMATIC HUB</h1>

        <div id="login-screen" class="screen">
            <input type="text" id="user-name" placeholder="Ø§Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø±">
            <button class="game-card" onclick="initRoom('create')">â• Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø­ÙÙ„Ø©</button>
            <input type="text" id="join-input" placeholder="ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©">
            <button class="game-card" onclick="initRoom('join')">ğŸ”— Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ØªØ­Ø¯ÙŠ</button>
        </div>

        <div id="lobby-screen" class="screen hidden">
            <h2 id="room-id-view" class="gold-text"></h2>
            <div class="glass-box">
                <p>Ø§Ù„Ø£Ø¨Ø·Ø§Ù„ Ø§Ù„Ù…Ø³ØªØ¹Ø¯ÙˆÙ†:</p>
                <div id="players-list"></div>
            </div>
            <button id="host-start-btn" class="action-btn hidden" onclick="startParty()">Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ­Ø¯ÙŠ Ø§Ù„Ø¢Ù†! ğŸš€</button>
        </div>

        <div id="game-screen" class="screen hidden">
            <div class="timer-wrapper"><div id="timer-bar"></div></div>
            <div class="glass-box">
                <h3 id="question-display">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø¤Ø§Ù„...</h3>
            </div>
            <input type="text" id="answer-input" placeholder="Ø§ÙƒØªØ¨ Ø¥Ø¬Ø§Ø¨ØªÙƒ Ù‡Ù†Ø§ Ø¨Ø³Ø±Ø¹Ø©!" oninput="sendLiveGuess()">
            
            <div class="live-feed-box">
                <p style="font-size: 0.8rem; color: var(--gold);">Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­ÙŠØ© Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† (Live Feed):</p>
                <div id="feed-stream"></div>
            </div>
        </div>

        <div id="result-screen" class="screen hidden">
            <h2 class="gold-text">Ù„ÙˆØ­Ø© Ø§Ù„ØµØ¯Ø§Ø±Ø© ğŸ†</h2>
            <div id="leaderboard" class="glass-box"></div>
            <div id="host-nav" class="hidden">
                <button class="action-btn" onclick="nextQuestion()">Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ â¡ï¸</button>
                <button class="game-card" onclick="resetToHome()">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ø§Ø®ØªÙŠØ§Ø± Ù„Ø¹Ø¨Ø© ğŸ </button>
            </div>
            <p id="guest-wait-msg" class="hidden">Ø§Ù†ØªØ¸Ø± Ø§Ù„Ù…Ø¶ÙŠÙ Ù„Ù„Ø§Ù†ØªÙ‚Ø§Ù„...</p>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>

    <script>
        // Ø§Ù„ÙƒÙˆØ¯ Ù…Ø¯Ù…Ø¬ Ù‡Ù†Ø§ Ø¹Ø´Ø§Ù† "ÙŠØ¯ÙˆØ³" Ù…Ø¹Ø§Ùƒ ÙÙˆØ±Ø§Ù‹
        const firebaseConfig = {
            apiKey: "AIzaSyAESCjnKsQxNX_IKH9Fm_ePpIsbb9C_NsE",
            authDomain: "diplomatic-games.firebaseapp.com",
            projectId: "diplomatic-games",
            storageBucket: "diplomatic-games.firebasestorage.app",
            messagingSenderId: "726415224604",
            appId: "1:726415224604:web:3f436ef230254a5ee914d9",
            databaseURL: "https://diplomatic-games-default-rtdb.firebaseio.com"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let me = { name: '', room: '', isHost: false, score: 0 };
        const qBank = [
            {q: "Ù…Ù† Ù‡Ø¯Ø§Ù Ø§Ù„Ø¹Ø§Ù„Ù… Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠØŸ", a: "Ø±ÙˆÙ†Ø§Ù„Ø¯Ùˆ"},
            {q: "Ù…Ø§ Ù‡Ùˆ Ù†Ø§Ø¯ÙŠ Ø§Ù„Ù‚Ø±Ù† ÙÙŠ Ø£ÙØ±ÙŠÙ‚ÙŠØ§ØŸ", a: "Ø§Ù„Ø§Ù‡Ù„ÙŠ"},
            {q: "Ø£ÙŠÙ† Ø³ØªÙ‚Ø§Ù… ÙƒØ£Ø³ Ø§Ù„Ø¹Ø§Ù„Ù… 2026ØŸ", a: "Ø§Ù…Ø±ÙŠÙƒØ§"}
        ];

        window.initRoom = (mode) => {
            me.name = document.getElementById('user-name').value.trim() || "Ù„Ø§Ø¹Ø¨_" + Math.floor(Math.random()*99);
            me.room = mode === 'create' ? Math.random().toString(36).substring(2, 6).toUpperCase() : document.getElementById('join-input').value.toUpperCase();
            me.isHost = mode === 'create';

            if(me.isHost) {
                db.ref('party/' + me.room).set({ status: 'lobby', qIdx: 0, timer: 20 });
            }
            db.ref('party/' + me.room + '/players/' + me.name).set({ score: 0, currentGuess: '' });
            
            listenToUpdates();
            showScreen('lobby-screen');
        };

        function listenToUpdates() {
            document.getElementById('room-id-view').innerText = "ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©: " + me.room;
            db.ref('party/' + me.room).on('value', (snap) => {
                const data = snap.val();
                if(!data) return;

                const pDiv = document.getElementById('players-list');
                const feed = document.getElementById('feed-stream');
                const board = document.getElementById('leaderboard');
                pDiv.innerHTML = ""; feed.innerHTML = ""; board.innerHTML = "";
                
                let sorted = [];
                for(let p in data.players) {
                    pDiv.innerHTML += `<span> ğŸ‘¤ ${p} </span>`;
                    if(data.players[p].currentGuess) feed.innerHTML += `<p><strong>${p}:</strong> ${data.players[p].currentGuess}</p>`;
                    sorted.push({name: p, score: data.players[p].score});
                }

                if(data.status === 'playing') {
                    showScreen('game-screen');
                    document.getElementById('question-display').innerText = qBank[data.qIdx].q;
                    document.getElementById('timer-bar').style.width = (data.timer / 20 * 100) + "%";
                } else if(data.status === 'results') {
                    showScreen('result-screen');
                    sorted.sort((a,b) => b.score - a.score).forEach((p, i) => {
                        board.innerHTML += `<p>${i+1}. ${p.name} - ${p.score} Ù†Ù‚Ø·Ø©</p>`;
                    });
                    document.getElementById('host-nav').classList.toggle('hidden', !me.isHost);
                    document.getElementById('guest-wait-msg').classList.toggle('hidden', me.isHost);
                }

                if(me.isHost) document.getElementById('host-start-btn').classList.toggle('hidden', data.status !== 'lobby');
            });
        }

        window.sendLiveGuess = () => {
            const val = document.getElementById('answer-input').value;
            db.ref('party/' + me.room + '/players/' + me.name).update({ currentGuess: val });
            
            db.ref('party/' + me.room + '/qIdx').once('value', (s) => {
                if(val.trim() === qBank[s.val()].a) {
                    me.score += 10;
                    db.ref('party/' + me.room + '/players/' + me.name).update({ score: me.score, currentGuess: 'âœ… Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©!' });
                    document.getElementById('answer-input').value = "";
                }
            });
        };

        window.startParty = () => {
            db.ref('party/' + me.room).update({ status: 'playing' });
            runTimer();
        };

        function runTimer() {
            let t = 20;
            let inter = setInterval(() => {
                t--;
                db.ref('party/' + me.room).update({ timer: t });
                if(t <= 0) {
                    clearInterval(inter);
                    db.ref('party/' + me.room).update({ status: 'results' });
                }
            }, 1000);
        }

        window.nextQuestion = () => {
            db.ref('party/' + me.room + '/qIdx').once('value', (s) => {
                db.ref('party/' + me.room).update({ qIdx: s.val() + 1, status: 'playing', timer: 20 });
                runTimer();
            });
        };

        window.resetToHome = () => {
            db.ref('party/' + me.room).remove();
            location.reload();
        };

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }
    </script>
</body>
</html>
