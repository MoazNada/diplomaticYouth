<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIPLOMATIC HUB - STABLE</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="app" class="container">
        <h1 class="gold-text">DIPLOMATIC HUB</h1>

        <div id="category-screen" class="screen">
            <h3>ุงุฎุชุฑ ููุน ุงูุชุญุฏู</h3>
            <button class="game-card" onclick="setGame('kora')">โฝ ููุฑุฉ</button>
            <button class="game-card" onclick="setGame('fawazir')">๐ ููุงุฒูุฑ</button>
            <button class="game-card" onclick="setGame('no_repeat')">๐ซ ุจุฏูู ุชูุฑุงุฑ</button>
            <button class="game-card" onclick="setGame('what_if')">๐ค ูู ููุช ููุงูู</button>
            <div style="margin-top:20px;">
                <select id="q-count-select" class="action-btn" style="background:#222; color:white;">
                    <option value="10">10 ุฃุณุฆูุฉ</option>
                    <option value="20" selected>20 ุณุคุงู</option>
                </select>
            </div>
        </div>

        <div id="online-setup-screen" class="screen hidden">
            <input type="text" id="user-name" placeholder="ุงุณูู">
            <button class="action-btn" onclick="initRoom('create')">โ ุฅูุดุงุก ุบุฑูุฉ</button>
            <input type="text" id="join-input" placeholder="ููุฏ ุงูุบุฑูุฉ">
            <button class="game-card" onclick="initRoom('join')">๐ ุงูุถูุงู</button>
        </div>

        <div id="lobby-screen" class="screen hidden">
            <h1 id="room-display" class="gold-text"></h1>
            <div class="glass-box"><div id="players-list"></div></div>
            <button id="host-start-btn" class="action-btn hidden" onclick="triggerStart()">ุงุจุฏุฃ ๐</button>
        </div>

        <div id="game-screen" class="screen hidden">
            <p id="q-info" style="color:var(--gold);"></p>
            <div class="glass-box"><h3 id="question-text">ุฌุงุฑู ุงูุชุญููู...</h3></div>
            <div id="input-zone">
                <input type="text" id="ans-input" placeholder="ุงูุชุจ ุฅุฌุงุจุชู...">
                <button class="action-btn" onclick="submitProcess()">ุฅุฑุณุงู โ</button>
            </div>
            <div id="waiting-msg" class="hidden">ุชู ุงูุฅุฑุณุงู.. ุจุงูุชุธุงุฑ ุงูุจููุฉ โณ</div>
        </div>

        <div id="result-screen" class="screen hidden">
            <h3 class="gold-text">ุงููุชุงุฆุฌ ๐</h3>
            <div id="leaderboard" class="glass-box"></div>
            <div class="glass-box" style="border: 1px solid #00ff88;">
                <p>ุงูุฅุฌุงุจุงุช ุงูุตุญูุญุฉ:</p>
                <div id="correct-reveal" style="color:#00ff88;"></div>
            </div>
            <div id="host-controls" class="hidden">
                <button class="action-btn" onclick="triggerNext()">ุงูุณุคุงู ุงูุชุงูู โก๏ธ</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>

    <script>
        // ุฅุนุฏุงุฏุงุช Firebase ูุจูู ุงูุฃุณุฆูุฉ (ููุณ ุงูู 80 ุณุคุงู)
        const firebaseConfig = {
            apiKey: "AIzaSyAESCjnKsQxNX_IKH9Fm_ePpIsbb9C_NsE",
            authDomain: "diplomatic-games.firebaseapp.com",
            projectId: "diplomatic-games",
            storageBucket: "diplomatic-games.firebasestorage.app",
            messagingSenderId: "726415224604",
            appId: "1:726415224604:web:3f436ef230254a5ee914d9",
            databaseURL: "https://diplomatic-games-default-rtdb.firebaseio.com"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let me = { name: '', room: '', isHost: false, gameType: '', maxQ: 20, score: 0 };
        
        // ุจูู ุงูุฃุณุฆูุฉ (ุชุฃูุฏ ูู ูุฌูุฏ ุงูู 80 ุณุคุงู ููุง)
        const dataBank = {
            kora: [ {q:"ูู ูุฏุงู ุงูุนุงูู ุงูุชุงุฑูุฎูุ", a:["ุฑููุงูุฏู", "ูุฑูุณุชูุงูู"]}, /* ... ุจุงูู ุงูู 20 ุณุคุงู ... */ ],
            fawazir: [ {q:"ุดูุก ูุทูุฑ ุจูุง ุฃุฌูุญุฉุ", a:["ุงูุฏุฎุงู", "ุฏุฎุงู"]}, /* ... ุจุงูู ุงูู 20 ุณุคุงู ... */ ],
            no_repeat: [ {q:"ุงุฐูุฑ ูุงููุฉ ุตูููุฉ", a:["ุจุทูุฎ", "ูุงูุฌู", "ูุงูุฌุง"]}, /* ... ุจุงูู ุงูู 20 ุณุคุงู ... */ ],
            what_if: [ {q:"ูู ูููุช ูุญูุธุฉุ", a:["ูุฑุฌุนูุง", "ุงุณูููุง"]}, /* ... ุจุงูู ุงูู 20 ุณุคุงู ... */ ]
        };

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        window.setGame = (g) => { me.gameType = g; me.maxQ = parseInt(document.getElementById('q-count-select').value); showScreen('online-setup-screen'); };

        window.initRoom = (type) => {
            me.name = document.getElementById('user-name').value.trim() || "ูุงุนุจ";
            me.room = type === 'create' ? Math.random().toString(36).substring(2,6).toUpperCase() : document.getElementById('join-input').value.toUpperCase();
            me.isHost = type === 'create';
            if(me.isHost) db.ref('party/' + me.room).set({ status: 'lobby', qIdx: 0, game: me.gameType, maxQ: me.maxQ });
            db.ref('party/' + me.room + '/players/' + me.name).set({ score: 0, submitted: false, lastAns: '' });
            listen(); showScreen('lobby-screen');
        };

        function listen() {
            db.ref('party/' + me.room).on('value', (snap) => {
                const data = snap.val(); if(!data) return;
                document.getElementById('room-display').innerText = "ููุฏ ุงูุบุฑูุฉ: " + me.room;
                
                // ุชุญุฏูุซ ุงููุงุนุจูู ูุงููุชุงุฆุฌ
                let playersArr = [];
                let allSubmitted = true;
                for(let p in data.players) {
                    playersArr.push({name: p, score: data.players[p].score, sub: data.players[p].submitted});
                    if(!data.players[p].submitted) allSubmitted = false;
                }

                // ุงูููุทู ุงูุฑุฆูุณู ููุงูุชูุงู
                if(data.status === 'playing') {
                    showScreen('game-screen');
                    const currentQ = dataBank[data.game][data.qIdx];
                    document.getElementById('question-text').innerText = currentQ ? currentQ.q : "ุงูุชูุช ุงูุฃุณุฆูุฉ";
                    document.getElementById('q-info').innerText = `ุณุคุงู ${data.qIdx + 1} ูู ${data.maxQ}`;
                    
                    // ูู ุงููุถูู ูุงููู ุณูู.. ุงููู ููุชุงุฆุฌ ุงูุณุคุงู
                    if(allSubmitted && me.isHost) db.ref('party/' + me.room).update({ status: 'results' });
                } 
                else if(data.status === 'results') {
                    showScreen('result-screen');
                    const currentQ = dataBank[data.game][data.qIdx];
                    document.getElementById('correct-reveal').innerText = currentQ ? currentQ.a.join(" / ") : "";
                    document.getElementById('host-controls').classList.toggle('hidden', !me.isHost);
                    
                    let boardHTML = "";
                    playersArr.sort((a,b) => b.score - a.score).forEach(p => {
                        boardHTML += `<p>๐ค ${p.name}: ${p.score}ู ${p.sub ? 'โ' : 'โณ'}</p>`;
                    });
                    document.getElementById('leaderboard').innerHTML = boardHTML;
                }
                
                if(me.isHost) document.getElementById('host-start-btn').classList.toggle('hidden', data.status !== 'lobby');
            });
        }

        window.submitProcess = () => {
            const val = document.getElementById('ans-input').value.trim();
            db.ref('party/' + me.room).once('value', s => {
                const data = s.val();
                const correctOnes = dataBank[data.game][data.qIdx].a;
                let isCorrect = correctOnes.some(ans => val.toLowerCase().includes(ans.toLowerCase()) || ans.toLowerCase().includes(val.toLowerCase()));
                
                if(isCorrect && val !== "") me.score += 10;
                db.ref('party/' + me.room + '/players/' + me.name).update({ score: me.score, submitted: true, lastAns: val });
                document.getElementById('input-zone').classList.add('hidden');
                document.getElementById('waiting-msg').classList.remove('hidden');
                document.getElementById('ans-input').value = "";
            });
        };

        window.triggerStart = () => db.ref('party/' + me.room).update({ status: 'playing', qIdx: 0 });

        window.triggerNext = () => {
            db.ref('party/' + me.room).once('value', s => {
                const data = s.val();
                let next = data.qIdx + 1;
                if(next >= data.maxQ) { alert("ุงูุชูู ุงูุฌูู!"); location.reload(); return; }
                
                // ุฑูุณุช ุฅุฑุณุงู ุงููุงุนุจูู
                let updates = {};
                for(let p in data.players) updates[`players/${p}/submitted`] = false;
                updates['status'] = 'playing';
                updates['qIdx'] = next;
                db.ref('party/' + me.room).update(updates);
            });
        };
    </script>
</body>
</html>
