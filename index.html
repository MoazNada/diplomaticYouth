<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIPLOMATIC HUB - JUDGE MODE</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="app" class="container">
        <h1 class="gold-text">DIPLOMATIC HUB</h1>

        <div id="main-screen" class="screen">
            <button class="game-card" onclick="showScreen('category-screen')">ğŸŒ Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨</button>
            <button class="game-card" onclick="location.reload()">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„</button>
        </div>

        <div id="category-screen" class="screen hidden">
            <h3>Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØªØ­Ø¯ÙŠ</h3>
            <button class="game-card" onclick="selectGame('kora')">âš½ ÙƒÙˆØ±Ø© (Ø³Ø±Ø¹Ø©)</button>
            <button class="game-card" onclick="selectGame('fawazir')">ğŸŒ™ ÙÙˆØ§Ø²ÙŠØ± (Ø°ÙƒØ§Ø¡)</button>
            <button class="game-card" onclick="selectGame('no_repeat')">ğŸš« Ø¨Ø¯ÙˆÙ† ØªÙƒØ±Ø§Ø± (ØªØ­Ø¯ÙŠ)</button>
            <button class="game-card" onclick="selectGame('what_if')">ğŸ¤” Ù„Ùˆ ÙƒÙ†Øª Ù…ÙƒØ§Ù†Ùƒ</button>
            <button class="back-nav-btn" onclick="showScreen('main-screen')">Ø±Ø¬ÙˆØ¹</button>
        </div>

        <div id="login-screen" class="screen hidden">
            <input type="text" id="user-name" placeholder="Ø§Ø³Ù…Ùƒ">
            <button class="action-btn" onclick="initParty('create')">Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ©</button>
            <input type="text" id="join-input" placeholder="ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©">
            <button class="game-card" onclick="initParty('join')">Ø§Ù†Ø¶Ù…Ø§Ù…</button>
        </div>

        <div id="lobby-screen" class="screen hidden">
            <h2 id="room-display" class="gold-text"></h2>
            <div id="players-list" class="glass-box"></div>
            <button id="start-btn" class="action-btn hidden" onclick="launch()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¬ÙŠÙ… ğŸš€</button>
        </div>

        <div id="game-screen" class="screen hidden">
            <div class="timer-wrapper"><div id="timer-bar"></div></div>
            <div class="glass-box">
                <h3 id="q-view"></h3>
                <p id="game-hint" style="font-size:0.8rem; color:var(--gold);"></p>
            </div>
            <input type="text" id="ans-input" placeholder="Ø§ÙƒØªØ¨ Ø¥Ø¬Ø§Ø¨ØªÙƒ Ù‡Ù†Ø§...">
            <button class="action-btn" onclick="submitAns()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© âœ…</button>
            <p id="wait-msg" class="hidden">ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø¥Ø¬Ø§Ø¨ØªÙƒ.. Ø§Ù†ØªØ¸Ø± Ø§Ù„Ø¨Ø§Ù‚ÙŠ</p>
        </div>

        <div id="judge-screen" class="screen hidden">
            <h3 class="gold-text">Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªØ­ÙƒÙŠÙ… ÙˆØ§Ù„ÙƒØ´Ù âš–ï¸</h3>
            <div id="answers-to-judge" class="glass-box"></div>
            <div id="official-ans" class="glass-box hidden" style="border-color:#00ff88">
                <p>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ÙŠØ©:</p>
                <h2 id="model-ans"></h2>
            </div>
            <div id="host-controls" class="hidden">
                <button class="action-btn" onclick="nextRound()">Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ â¡ï¸</button>
                <button class="game-card" onclick="location.reload()">Ø®Ø±ÙˆØ¬</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAESCjnKsQxNX_IKH9Fm_ePpIsbb9C_NsE",
            authDomain: "diplomatic-games.firebaseapp.com",
            projectId: "diplomatic-games",
            storageBucket: "diplomatic-games.firebasestorage.app",
            messagingSenderId: "726415224604",
            appId: "1:726415224604:web:3f436ef230254a5ee914d9",
            databaseURL: "https://diplomatic-games-default-rtdb.firebaseio.com"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let state = { name: '', room: '', isHost: false, game: '', qIdx: 0 };
        const dataBank = {
            kora: [{q:"Ù‡Ø¯Ø§Ù Ø§Ù„Ø¹Ø§Ù„Ù…ØŸ", a:"Ø±ÙˆÙ†Ø§Ù„Ø¯Ùˆ"}, {q:"Ù†Ø§Ø¯ÙŠ Ø§Ù„Ù‚Ø±Ù†ØŸ", a:"Ø§Ù„Ø§Ù‡Ù„ÙŠ"}],
            fawazir: [{q:"Ø´ÙŠØ¡ ÙŠØ·ÙŠØ± Ø¨Ù„Ø§ Ø£Ø¬Ù†Ø­Ø©ØŸ", a:"Ø§Ù„Ø¯Ø®Ø§Ù†"}],
            no_repeat: [{q:"Ø§Ø°ÙƒØ± Ø§Ø³Ù… ÙØ§ÙƒÙ‡Ø© Ù„ÙˆÙ†Ù‡Ø§ Ø£Ø­Ù…Ø±", a:"(ØªÙØ§Ø­ØŒ ÙØ±Ø§ÙˆÙ„Ø©ØŒ Ø±Ù…Ø§Ù†...)"}],
            what_if: [{q:"Ù„Ùˆ ÙƒÙ†Øª Ù…ÙƒØ§Ù†Ùƒ ÙˆÙˆØ¬Ø¯Øª Ø´Ù†Ø·Ø© ÙÙ„ÙˆØ³ØŸ", a:"(Ø±Ø£ÙŠ Ø§Ù„Ù„Ø§Ø¹Ø¨)"}]
        };

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        window.selectGame = (g) => { state.game = g; showScreen('login-screen'); };

        window.initParty = (type) => {
            state.name = document.getElementById('user-name').value || "Ù„Ø§Ø¹Ø¨";
            state.room = type === 'create' ? Math.random().toString(36).substring(2,6).toUpperCase() : document.getElementById('join-input').value.toUpperCase();
            state.isHost = type === 'create';
            
            if(state.isHost) db.ref('hub/'+state.room).set({status:'lobby', qIdx:0, game:state.game, timer:20});
            db.ref('hub/'+state.room+'/players/'+state.name).set({score:0, ans:'', submitted: false});
            
            listen();
            showScreen('lobby-screen');
        };

        function listen() {
            document.getElementById('room-display').innerText = "ÙƒÙˆØ¯: " + state.room;
            db.ref('hub/'+state.room).on('value', (snap) => {
                const val = snap.val(); if(!val) return;
                
                // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†
                const list = document.getElementById('players-list');
                list.innerHTML = "";
                for(let p in val.players) list.innerHTML += `<p>ğŸ‘¤ ${p} - ${val.players[p].score}Ù†</p>`;

                if(val.status === 'playing') {
                    showScreen('game-screen');
                    document.getElementById('q-view').innerText = dataBank[val.game][val.qIdx].q;
                    document.getElementById('timer-bar').style.width = (val.timer/20*100) + "%";
                } else if(val.status === 'judging') {
                    showScreen('judge-screen');
                    renderJudgement(val);
                }
                if(state.isHost) document.getElementById('start-btn').classList.toggle('hidden', val.status !== 'lobby');
            });
        }

        window.submitAns = () => {
            const a = document.getElementById('ans-input').value;
            db.ref('hub/'+state.room+'/players/'+state.name).update({ans: a, submitted: true});
            document.getElementById('ans-input').classList.add('hidden');
            document.getElementById('wait-msg').classList.remove('hidden');
        };

        window.launch = () => {
            db.ref('hub/'+state.room).update({status: 'playing'});
            let t = 20;
            let i = setInterval(() => {
                t--; db.ref('hub/'+state.room).update({timer: t});
                if(t <= 0) { clearInterval(i); db.ref('hub/'+state.room).update({status: 'judging'}); }
            }, 1000);
        };

        function renderJudgement(val) {
            const div = document.getElementById('answers-to-judge');
            div.innerHTML = "<h4>Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†:</h4>";
            const allAns = [];
            
            for(let p in val.players) {
                const pAns = val.players[p].ans;
                const isDup = Object.values(val.players).filter(x => x.ans === pAns && pAns !== '').length > 1;
                
                let style = isDup && val.game === 'no_repeat' ? "color:red" : "";
                let txt = isDup && val.game === 'no_repeat' ? `${pAns} (Ù…ÙƒØ±Ø±! âŒ)` : pAns;

                div.innerHTML += `
                    <div style="margin:10px; border-bottom:1px solid #333; padding:5px;">
                        <span style="${style}"><strong>${p}:</strong> ${txt}</span>
                        ${state.isHost ? `<button onclick="givePoint('${p}')" style="margin-right:10px;">âœ… ØµØ­</button>` : ''}
                    </div>`;
            }
            
            document.getElementById('model-ans').innerText = dataBank[val.game][val.qIdx].a;
            document.getElementById('official-ans').classList.remove('hidden');
            if(state.isHost) document.getElementById('host-controls').classList.remove('hidden');
        }

        window.givePoint = (pName) => {
            db.ref('hub/'+state.room+'/players/'+pName+'/score').transaction(s => (s||0)+10);
        };

        window.nextRound = () => {
            db.ref('hub/'+state.room).once('value', s => {
                const next = s.val().qIdx + 1;
                db.ref('hub/'+state.room).update({qIdx: next, status: 'playing', timer: 20});
                // Ø±ÙŠØ³Øª Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª
                for(let p in s.val().players) db.ref('hub/'+state.room+'/players/'+p).update({ans:'', submitted:false});
                window.launch();
            });
        };
    </script>
</body>
</html>
