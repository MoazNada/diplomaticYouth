<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIPLOMATIC HUB - ULTRA</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="app" class="container">
        <h1 class="gold-text">DIPLOMATIC HUB</h1>

        <div id="category-screen" class="screen">
            <h3>Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù„Ø¹Ø¨Ø©</h3>
            <button class="game-card" onclick="selectGame('kora')">âš½ ÙƒÙˆØ±Ø©</button>
            <button class="game-card" onclick="selectGame('fawazir')">ğŸŒ™ ÙÙˆØ§Ø²ÙŠØ±</button>
            <div style="margin-top:20px;">
                <p>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©:</p>
                <select id="q-count-select" class="action-btn" style="background:#222; color:white;">
                    <option value="10">10 Ø£Ø³Ø¦Ù„Ø©</option>
                    <option value="20">20 Ø³Ø¤Ø§Ù„</option>
                </select>
            </div>
        </div>

        <div id="lobby-screen" class="screen hidden">
            <h2 id="room-code" class="gold-text"></h2>
            <div id="players-list" class="glass-box"></div>
            <button id="host-start-btn" class="action-btn hidden" onclick="startNewRound(true)">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¬ÙŠÙ… ğŸš€</button>
        </div>

        <div id="game-screen" class="screen hidden">
            <div class="timer-wrapper"><div id="timer-bar"></div></div>
            <p id="q-status" style="color:var(--gold);"></p>
            <div class="glass-box">
                <h3 id="question-text">...</h3>
            </div>
            <div id="input-zone">
                <input type="text" id="ans-input" placeholder="Ø§ÙƒØªØ¨ Ø¥Ø¬Ø§Ø¨ØªÙƒ Ù‡Ù†Ø§...">
                <button class="action-btn" onclick="submitAndCheck()">Ø¥Ø±Ø³Ø§Ù„ âœ…</button>
            </div>
            <div id="feedback" class="hidden" style="font-size: 1.5rem; margin-top:10px;"></div>
        </div>

        <div id="result-screen" class="screen hidden">
            <h3 class="gold-text">Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ğŸ†</h3>
            <div id="leaderboard" class="glass-box"></div>
            <div class="glass-box" style="border:1px solid #00ff88">
                <p>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© ÙƒØ§Ù†Øª:</p>
                <h2 id="correct-reveal" style="color:#00ff88"></h2>
            </div>
            <div id="host-nav" class="hidden">
                <button id="next-q-btn" class="action-btn" onclick="startNewRound(false)">Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ â¡ï¸</button>
                <button class="game-card" onclick="location.reload()">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ğŸ </button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAESCjnKsQxNX_IKH9Fm_ePpIsbb9C_NsE",
            authDomain: "diplomatic-games.firebaseapp.com",
            projectId: "diplomatic-games",
            storageBucket: "diplomatic-games.firebasestorage.app",
            messagingSenderId: "726415224604",
            appId: "1:726415224604:web:3f436ef230254a5ee914d9",
            databaseURL: "https://diplomatic-games-default-rtdb.firebaseio.com"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let me = { name: '', room: '', isHost: false, game: '', score: 0, maxQ: 10 };
        const questions = {
            kora: [{q:"Ù…Ù† Ù‡Ø¯Ø§Ù Ø§Ù„Ø¹Ø§Ù„Ù…ØŸ", a:"Ø±ÙˆÙ†Ø§Ù„Ø¯Ùˆ"}, {q:"Ù†Ø§Ø¯ÙŠ Ø§Ù„Ù‚Ø±Ù†ØŸ", a:"Ø§Ù„Ø§Ù‡Ù„ÙŠ"}, {q:"Ø¨Ø·Ù„ Ù…ÙˆÙ†Ø¯ÙŠØ§Ù„ 2022ØŸ", a:"Ø§Ù„Ø§Ø±Ø¬Ù†ØªÙŠÙ†"}], // Ø²ÙˆØ¯ Ù„Ø­Ø¯ 20 Ù‡Ù†Ø§
            fawazir: [{q:"Ø´ÙŠØ¡ ÙŠÙƒØªØ¨ ÙˆÙ„Ø§ ÙŠÙ‚Ø±Ø£ØŸ", a:"Ø§Ù„Ù‚Ù„Ù…"}, {q:"Ù„Ù‡ Ø£Ø³Ù†Ø§Ù† ÙˆÙ„Ø§ ÙŠØ¹Ø¶ØŸ", a:"Ø§Ù„Ù…Ø´Ø·"}] // Ø²ÙˆØ¯ Ù„Ø­Ø¯ 20 Ù‡Ù†Ø§
        };

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        window.selectGame = (g) => {
            me.game = g;
            me.maxQ = document.getElementById('q-count-select').value;
            me.name = prompt("Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ") || "Ù„Ø§Ø¹Ø¨";
            me.room = Math.random().toString(36).substring(2,6).toUpperCase();
            me.isHost = true;
            
            db.ref('hub/'+me.room).set({status:'lobby', qIdx: 0, game: g, maxQ: me.maxQ, timer: 15});
            joinRoom(me.room);
        };

        // Ø¯Ø§Ù„Ø© Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… (Ù„Ù„ÙƒÙ„)
        function joinRoom(id) {
            me.room = id;
            db.ref('hub/'+id+'/players/'+me.name).set({score:0, submitted: false});
            listenUpdates();
            showScreen('lobby-screen');
        }

        function listenUpdates() {
            db.ref('hub/'+me.room).on('value', snap => {
                const data = snap.val(); if(!data) return;
                document.getElementById('room-code').innerText = "ÙƒÙˆØ¯: " + me.room;
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†
                const pList = document.getElementById('players-list');
                const board = document.getElementById('leaderboard');
                pList.innerHTML = ""; board.innerHTML = "";
                let allDone = true;
                
                for(let p in data.players) {
                    pList.innerHTML += `<p>ğŸ‘¤ ${p}: ${data.players[p].score}</p>`;
                    board.innerHTML += `<p>${p}: ${data.players[p].score} Ù†Ù‚Ø·Ø©</p>`;
                    if(!data.players[p].submitted) allDone = false;
                }

                // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø§Ù„ÙÙˆØ±ÙŠ Ù„Ù„Ù†ØªØ§Ø¦Ø¬ Ù„Ùˆ Ø§Ù„ÙƒÙ„ Ø¬Ø§ÙˆØ¨ [Quick-Skip]
                if(allDone && data.status === 'playing' && me.isHost) {
                    db.ref('hub/'+me.room).update({status: 'results'});
                }

                if(data.status === 'playing') {
                    showScreen('game-screen');
                    document.getElementById('question-text').innerText = questions[data.game][data.qIdx].q;
                    document.getElementById('q-status').innerText = `Ø³Ø¤Ø§Ù„ ${data.qIdx+1} Ù…Ù† ${data.maxQ}`;
                    document.getElementById('timer-bar').style.width = (data.timer/15*100) + "%";
                } else if(data.status === 'results') {
                    showScreen('result-screen');
                    document.getElementById('correct-reveal').innerText = questions[data.game][data.qIdx].a;
                    if(me.isHost) document.getElementById('host-nav').classList.remove('hidden');
                }
                
                if(me.isHost) document.getElementById('host-start-btn').classList.toggle('hidden', data.status !== 'lobby');
            });
        }

        window.submitAndCheck = () => {
            const userAns = document.getElementById('ans-input').value.trim();
            const correctAns = questions[me.game][0].a; // Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù€ index Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹
            const feedback = document.getElementById('feedback');
            
            feedback.classList.remove('hidden');
            if(userAns.toLowerCase() === correctAns.toLowerCase()) {
                feedback.innerHTML = "âœ… Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©!";
                feedback.style.color = "#00ff88";
                me.score += 10;
                db.ref('hub/'+me.room+'/players/'+me.name).update({score: me.score});
            } else {
                feedback.innerHTML = `âŒ Ø®Ø·Ø£! Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©: ${correctAns}`;
                feedback.style.color = "#ff4444";
            }
            
            db.ref('hub/'+me.room+'/players/'+me.name).update({submitted: true});
            document.getElementById('input-zone').classList.add('hidden');
        };

        window.startNewRound = (first) => {
            db.ref('hub/'+me.room).once('value', s => {
                let nextIdx = first ? 0 : s.val().qIdx + 1;
                // Ø±ÙŠØ³Øª Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†
                for(let p in s.val().players) db.ref('hub/'+me.room+'/players/'+p).update({submitted: false});
                
                db.ref('hub/'+me.room).update({status: 'playing', qIdx: nextIdx, timer: 15});
                
                // Ø§Ù„ØªÙˆÙ‚ÙŠØª
                let t = 15;
                let i = setInterval(() => {
                    t--; db.ref('hub/'+me.room).update({timer: t});
                    if(t <= 0) { clearInterval(i); db.ref('hub/'+me.room).update({status: 'results'}); }
                }, 1000);
            });
        };
    </script>
</body>
</html>
