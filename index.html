<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIPLOMATIC HUB - MEGA PARTY</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="app" class="container">
        <h1 class="gold-text">DIPLOMATIC HUB</h1>

        <div id="main-screen" class="screen">
            <button class="game-card" onclick="setMode('online')">ğŸŒ Ù„Ø¹Ø¨ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† (Party)</button>
            <button class="game-card" onclick="setMode('local')">ğŸ  Ù„Ø¹Ø¨ Ù…Ø­Ù„ÙŠ (Offline)</button>
        </div>

        <div id="category-screen" class="screen hidden">
            <h3 id="mode-title">Ø§Ø®ØªØ± Ø§Ù„Ù„Ø¹Ø¨Ø©</h3>
            <button class="game-card" onclick="selectGame('kora')">âš½ ØªØ­Ø¯ÙŠ Ø§Ù„ÙƒÙˆØ±Ø©</button>
            <button class="game-card" onclick="selectGame('fawazir')">ğŸŒ™ ÙÙˆØ§Ø²ÙŠØ± Ø±Ù…Ø¶Ø§Ù†</button>
            <button class="game-card" onclick="selectGame('spy')">ğŸ•µï¸ Ù…ÙŠÙ† Ø§Ù„Ø¬Ø§Ø³ÙˆØ³ØŸ</button>
            <button class="back-nav-btn" onclick="showScreen('main-screen')">Ø±Ø¬ÙˆØ¹</button>
        </div>

        <div id="login-screen" class="screen hidden">
            <input type="text" id="user-name" placeholder="Ø§Ø³Ù…Ùƒ Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø±">
            <button class="action-btn" onclick="initOnline('create')">â• Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ©</button>
            <input type="text" id="join-input" placeholder="ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©">
            <button class="game-card" onclick="initOnline('join')">ğŸ”— Ø§Ù†Ø¶Ù…Ø§Ù…</button>
        </div>

        <div id="lobby-screen" class="screen hidden">
            <h2 id="room-id-view" class="gold-text"></h2>
            <div class="glass-box">
                <p>Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†:</p>
                <div id="players-list"></div>
            </div>
            <button id="host-start-btn" class="action-btn hidden" onclick="startParty()">Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ­Ø¯ÙŠ! ğŸš€</button>
        </div>

        <div id="game-screen" class="screen hidden">
            <div class="timer-wrapper"><div id="timer-bar"></div></div>
            <div class="glass-box">
                <h3 id="question-display">...</h3>
                <h2 id="spy-word" class="gold-text hidden"></h2>
            </div>
            <div id="action-area">
                <input type="text" id="answer-input" placeholder="Ø§ÙƒØªØ¨ Ø¥Ø¬Ø§Ø¨ØªÙƒ..." oninput="sendLiveGuess()">
                <div class="live-feed-box">
                    <div id="feed-stream"></div>
                </div>
            </div>
        </div>

        <div id="result-screen" class="screen hidden">
            <h2 id="reveal-title" class="gold-text">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ù‡ÙŠ:</h2>
            <h1 id="correct-answer" style="color: #00ff88;"></h1>
            <hr>
            <h3>Ù„ÙˆØ­Ø© Ø§Ù„ØµØ¯Ø§Ø±Ø© ğŸ†</h3>
            <div id="leaderboard" class="glass-box"></div>
            <div id="host-nav" class="hidden">
                <button class="action-btn" onclick="nextQuestion()">Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ â¡ï¸</button>
                <button class="game-card" onclick="location.reload()">ØªØºÙŠÙŠØ± Ø§Ù„Ù„Ø¹Ø¨Ø© ğŸ </button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAESCjnKsQxNX_IKH9Fm_ePpIsbb9C_NsE",
            authDomain: "diplomatic-games.firebaseapp.com",
            projectId: "diplomatic-games",
            storageBucket: "diplomatic-games.firebasestorage.app",
            messagingSenderId: "726415224604",
            appId: "1:726415224604:web:3f436ef230254a5ee914d9",
            databaseURL: "https://diplomatic-games-default-rtdb.firebaseio.com"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let me = { name: '', room: '', isHost: false, score: 0, mode: '', game: '' };
        const data = {
            kora: [{q: "Ù…Ù† Ù‡Ø¯Ø§Ù Ø§Ù„Ø¹Ø§Ù„Ù… Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠØŸ", a: "Ø±ÙˆÙ†Ø§Ù„Ø¯Ùˆ"}, {q: "Ù†Ø§Ø¯ÙŠ Ø§Ù„Ù‚Ø±Ù† ÙÙŠ Ø£ÙØ±ÙŠÙ‚ÙŠØ§ØŸ", a: "Ø§Ù„Ø§Ù‡Ù„ÙŠ"}],
            fawazir: [{q: "Ø´ÙŠØ¡ ÙŠÙƒØªØ¨ ÙˆÙ„Ø§ ÙŠÙ‚Ø±Ø£ØŸ", a: "Ø§Ù„Ù‚Ù„Ù…"}, {q: "ÙŠÙ†Ø¨Ø¶ Ø¨Ù„Ø§ Ù‚Ù„Ø¨ØŸ", a: "Ø§Ù„Ø³Ø§Ø¹Ø©"}],
            spy: ["Ù…Ø·Ø§Ø±", "Ù…Ø³ØªØ´ÙÙ‰", "Ù…Ø·Ø¹Ù…", "Ù…Ù„Ø¹Ø¨", "Ù…Ø¯Ø±Ø³Ø©"]
        };

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        window.setMode = (m) => { me.mode = m; showScreen('category-screen'); };

        window.selectGame = (g) => {
            me.game = g;
            if (me.mode === 'online') showScreen('login-screen');
            else startLocalGame();
        };

        window.initOnline = (type) => {
            me.name = document.getElementById('user-name').value || "Ù„Ø§Ø¹Ø¨_" + Math.floor(Math.random()*99);
            me.room = type === 'create' ? Math.random().toString(36).substring(2, 6).toUpperCase() : document.getElementById('join-input').value.toUpperCase();
            me.isHost = type === 'create';

            if(me.isHost) {
                db.ref('party/' + me.room).set({ status: 'lobby', qIdx: 0, timer: 15, gameType: me.game, reveal: false });
            }
            db.ref('party/' + me.room + '/players/' + me.name).set({ score: 0, guess: '' });
            listenOnline();
            showScreen('lobby-screen');
        };

        function listenOnline() {
            document.getElementById('room-id-view').innerText = "ØºØ±ÙØ©: " + me.room;
            db.ref('party/' + me.room).on('value', (snap) => {
                const val = snap.val(); if(!val) return;
                
                const pList = document.getElementById('players-list');
                const board = document.getElementById('leaderboard');
                const feed = document.getElementById('feed-stream');
                pList.innerHTML = ""; board.innerHTML = ""; feed.innerHTML = "";
                
                let players = [];
                for(let p in val.players) {
                    pList.innerHTML += `<span> ğŸ‘¤ ${p} </span>`;
                    players.push({name: p, score: val.players[p].score});
                    if(val.players[p].guess) feed.innerHTML += `<p><strong>${p}:</strong> ${val.players[p].guess}</p>`;
                }

                if(val.status === 'playing') {
                    showScreen('game-screen');
                    const currentQ = data[val.gameType][val.qIdx];
                    document.getElementById('question-display').innerText = val.gameType === 'spy' ? "Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¬Ø§Ø³ÙˆØ³!" : currentQ.q;
                    document.getElementById('timer-bar').style.width = (val.timer / 15 * 100) + "%";
                } 
                else if(val.status === 'results') {
                    showScreen('result-screen');
                    const ans = data[val.gameType][val.qIdx];
                    document.getElementById('correct-answer').innerText = ans.a || "Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª!";
                    players.sort((a,b) => b.score - a.score).forEach(p => {
                        board.innerHTML += `<p>${p.name}: ${p.score} Ù†Ù‚Ø·Ø©</p>`;
                    });
                    if(me.isHost) document.getElementById('host-nav').classList.remove('hidden');
                }
                if(me.isHost) document.getElementById('host-start-btn').classList.toggle('hidden', val.status !== 'lobby');
            });
        }

        window.sendLiveGuess = () => {
            const val = document.getElementById('answer-input').value;
            db.ref('party/' + me.room + '/players/' + me.name).update({ guess: val });
            db.ref('party/' + me.room).once('value', (s) => {
                const q = data[s.val().gameType][s.val().qIdx];
                if(val.trim() === q.a) {
                    me.score += 10;
                    db.ref('party/' + me.room + '/players/' + me.name).update({ score: me.score, guess: 'âœ… ØµØ­!' });
                    document.getElementById('answer-input').value = "";
                }
            });
        };

        window.startParty = () => {
            db.ref('party/' + me.room).update({ status: 'playing' });
            let t = 15;
            let inter = setInterval(() => {
                t--; db.ref('party/' + me.room).update({ timer: t });
                if(t <= 0) {
                    clearInterval(inter);
                    db.ref('party/' + me.room).update({ status: 'results' });
                }
            }, 1000);
        };

        window.nextQuestion = () => {
            db.ref('party/' + me.room).once('value', (s) => {
                db.ref('party/' + me.room).update({ qIdx: s.val() + 1, status: 'playing', timer: 15 });
                window.startParty();
            });
        };
        
        // ÙƒÙˆØ¯ Ø§Ù„Ù„Ø¹Ø¨ Ø§Ù„Ù…Ø­Ù„ÙŠ Ø§Ù„Ø¨Ø³ÙŠØ·
        function startLocalGame() {
            showScreen('game-screen');
            document.getElementById('action-area').innerHTML = `<button class="action-btn" onclick="location.reload()">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>`;
            const q = data[me.game][0];
            document.getElementById('question-display').innerText = q.q || "Ø§Ù„Ù„Ø¹Ø¨ Ø§Ù„Ù…Ø­Ù„ÙŠ Ù…ÙØ¹Ù„ - Ø§Ø®ØªØ¨Ø± Ù†ÙØ³Ùƒ";
        }
    </script>
</body>
</html>
