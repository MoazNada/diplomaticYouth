<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIPLOMATIC HUB - REFEREE MODE</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .player-card { background: #222; padding: 10px; margin: 5px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #444; }
        .correct-btn { background: #00ff88; color: black; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .wrong-btn { background: #ff4444; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; margin-right: 5px; }
        .selected-correct { border: 2px solid #00ff88; background: #004422; }
    </style>
</head>
<body>
    <div id="app" class="container">
        <h1 class="gold-text">DIPLOMATIC HUB</h1>

        <div id="category-screen" class="screen">
            <h3>Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØªØ­Ø¯ÙŠ</h3>
            <button class="game-card" onclick="setGame('kora')">âš½ ÙƒÙˆØ±Ø©</button>
            <button class="game-card" onclick="setGame('fawazir')">ğŸŒ™ ÙÙˆØ§Ø²ÙŠØ±</button>
            <button class="game-card" onclick="setGame('no_repeat')">ğŸš« Ø¨Ø¯ÙˆÙ† ØªÙƒØ±Ø§Ø±</button>
            <button class="game-card" onclick="setGame('what_if')">ğŸ¤” Ù„Ùˆ ÙƒÙ†Øª Ù…ÙƒØ§Ù†Ùƒ</button>
            <div style="margin-top:20px;">
                <select id="q-count-select" class="action-btn" style="background:#222; color:white;">
                    <option value="10">10 Ø£Ø³Ø¦Ù„Ø©</option>
                    <option value="20" selected>20 Ø³Ø¤Ø§Ù„</option>
                </select>
            </div>
        </div>

        <div id="online-setup-screen" class="screen hidden">
            <input type="text" id="user-name" placeholder="Ø§Ø³Ù…Ùƒ">
            <button class="action-btn" onclick="initRoom('create')">â• Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© (Ù…Ø­ÙƒÙ…)</button>
            <input type="text" id="join-input" placeholder="ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©">
            <button class="game-card" onclick="initRoom('join')">ğŸ”— Ø§Ù†Ø¶Ù…Ø§Ù… ÙƒÙ„Ø§Ø¹Ø¨</button>
            <button class="back-nav-btn" onclick="showScreen('category-screen')">ğŸ”™ Ø±Ø¬ÙˆØ¹</button>
        </div>

        <div id="lobby-screen" class="screen hidden">
            <h1 id="room-display" class="gold-text" style="font-size: 3rem;"></h1>
            <div class="glass-box"><div id="players-list"></div></div>
            <button id="host-start-btn" class="action-btn hidden" onclick="triggerStart()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…ÙˆØ§Ø¬Ù‡Ø© ğŸš€</button>
        </div>

        <div id="game-screen" class="screen hidden">
            <p id="q-info" style="color:var(--gold); font-weight:bold;"></p>
            <div class="glass-box"><h3 id="question-text">...</h3></div>
            <div id="input-zone">
                <input type="text" id="ans-input" placeholder="Ø§ÙƒØªØ¨ Ø¥Ø¬Ø§Ø¨ØªÙƒ Ù‡Ù†Ø§...">
                <button class="action-btn" onclick="submitProcess()">Ø¥Ø±Ø³Ø§Ù„ âœ…</button>
            </div>
            <div id="waiting-msg" class="hidden">ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„.. Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¨Ù‚ÙŠØ© ÙˆØ§Ù„ØªØ­ÙƒÙŠÙ… âš–ï¸</div>
        </div>

        <div id="result-screen" class="screen hidden">
            <h3 class="gold-text">Ø§Ù„ØªØ­ÙƒÙŠÙ… ÙˆØ§Ù„Ù†ØªØ§Ø¦Ø¬ âš–ï¸</h3>
            <div id="judging-panel" class="glass-box">
                </div>
            <div class="glass-box" style="border: 1px solid #00ff88;">
                <p>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ÙŠØ©:</p>
                <h2 id="correct-reveal" style="color:#00ff88; font-size: 1.2rem;"></h2>
            </div>
            <div id="host-controls" class="hidden">
                <button class="action-btn" onclick="triggerNext()">Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ â¡ï¸</button>
                <button class="game-card" onclick="location.reload()">ğŸ  Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬ÙŠÙ…</button>
            </div>
            <div id="guest-waiting" class="hidden">Ø§Ù„Ù…Ø­ÙƒÙ… ÙŠØ±Ø§Ø¬Ø¹ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ø¢Ù†...</div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>

    <script>
        // ... (Ù†ÙØ³ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©) ...
        const firebaseConfig = {
            apiKey: "AIzaSyAESCjnKsQxNX_IKH9Fm_ePpIsbb9C_NsE",
            authDomain: "diplomatic-games.firebaseapp.com",
            projectId: "diplomatic-games",
            storageBucket: "diplomatic-games.firebasestorage.app",
            messagingSenderId: "726415224604",
            appId: "1:726415224604:web:3f436ef230254a5ee914d9",
            databaseURL: "https://diplomatic-games-default-rtdb.firebaseio.com"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let me = { name: '', room: '', isHost: false, gameType: '', maxQ: 20, score: 0 };
        const dataBank = { /* ... Ù†ÙØ³ Ø¨Ù†Ùƒ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù€ 80 Ø§Ù„Ù…Ø°ÙƒÙˆØ± Ø³Ø§Ø¨Ù‚Ø§Ù‹ ... */ };
        // (Ù…Ù„Ø§Ø­Ø¸Ø©: ØªØ£ÙƒØ¯ Ù…Ù† Ù†Ø³Ø® Ù…ØµÙÙˆÙØ© Ø§Ù„Ù€ dataBank Ù…Ù† Ø§Ù„Ø±Ø¯ Ø§Ù„Ø³Ø§Ø¨Ù‚ Ù„ØªØ¹Ù…Ù„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©)

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        window.setGame = (g) => {
            me.gameType = g;
            me.maxQ = parseInt(document.getElementById('q-count-select').value);
            showScreen('online-setup-screen');
        };

        window.initRoom = (type) => {
            me.name = document.getElementById('user-name').value.trim() || "Ù„Ø§Ø¹Ø¨_" + Math.floor(Math.random()*99);
            me.room = type === 'create' ? Math.random().toString(36).substring(2,6).toUpperCase() : document.getElementById('join-input').value.toUpperCase();
            me.isHost = type === 'create';
            if(me.isHost) db.ref('party/' + me.room).set({ status: 'lobby', qIdx: 0, game: me.gameType, maxQ: me.maxQ });
            db.ref('party/' + me.room + '/players/' + me.name).set({ score: 0, submitted: false, lastAns: '' });
            listen(); showScreen('lobby-screen');
        };

        function listen() {
            db.ref('party/' + me.room).on('value', (snap) => {
                const data = snap.val(); if(!data) return;
                document.getElementById('room-display').innerText = me.room;
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù„ÙˆØ¨ÙŠ
                const pList = document.getElementById('players-list');
                pList.innerHTML = "";
                let allDone = true; let count = 0;
                
                for(let p in data.players) {
                    count++;
                    pList.innerHTML += `<p>ğŸ‘¤ ${p}: ${data.players[p].score}Ù†</p>`;
                    if(!data.players[p].submitted) allDone = false;
                }

                // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ù†ØªØ§Ø¦Ø¬ (Ø§Ù„ØªØ­ÙƒÙŠÙ…) Ù„Ù…Ø§ Ø§Ù„ÙƒÙ„ ÙŠØ®Ù„Øµ
                if(allDone && count > 0 && data.status === 'playing' && me.isHost) {
                    db.ref('party/' + me.room).update({ status: 'judging' });
                }

                if(data.status === 'playing') {
                    showScreen('game-screen');
                    document.getElementById('input-zone').classList.remove('hidden');
                    document.getElementById('waiting-msg').classList.add('hidden');
                    document.getElementById('question-text').innerText = dataBank[data.game][data.qIdx].q;
                    document.getElementById('q-info').innerText = `Ø³Ø¤Ø§Ù„ ${data.qIdx + 1} Ù…Ù† ${data.maxQ}`;
                } else if(data.status === 'judging') {
                    showScreen('result-screen');
                    renderJudgingPanel(data);
                    document.getElementById('correct-reveal').innerText = dataBank[data.game][data.qIdx].a.join(" / ");
                    document.getElementById('host-controls').classList.toggle('hidden', !me.isHost);
                    document.getElementById('guest-waiting').classList.toggle('hidden', me.isHost);
                }
                if(me.isHost) document.getElementById('host-start-btn').classList.toggle('hidden', data.status !== 'lobby');
            });
        }

        function renderJudgingPanel(data) {
            const panel = document.getElementById('judging-panel');
            panel.innerHTML = "<h4>Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†:</h4>";
            for(let p in data.players) {
                const pData = data.players[p];
                const div = document.createElement('div');
                div.className = 'player-card';
                div.innerHTML = `<span><strong>${p}:</strong> ${pData.lastAns || 'Ù„Ù… ÙŠØ¬Ø§ÙˆØ¨'}</span>`;
                
                if(me.isHost) {
                    const btn = document.createElement('button');
                    btn.className = 'correct-btn';
                    btn.innerText = "ØµØ­ âœ…";
                    btn.onclick = () => awardPoint(p, pData.score);
                    div.appendChild(btn);
                } else {
                    div.innerHTML += `<span>(${pData.score}Ù†)</span>`;
                }
                panel.appendChild(div);
            }
        }

        window.awardPoint = (playerName, currentScore) => {
            db.ref('party/' + me.room + '/players/' + playerName).update({ score: currentScore + 10 });
            alert(`ØªÙ… Ø¥Ø¹Ø·Ø§Ø¡ 10 Ù†Ù‚Ø§Ø· Ù„Ù€ ${playerName}`);
        };

        window.submitProcess = () => {
            const val = document.getElementById('ans-input').value.trim();
            db.ref('party/' + me.room + '/players/' + me.name).update({ submitted: true, lastAns: val });
            document.getElementById('input-zone').classList.add('hidden');
            document.getElementById('waiting-msg').classList.remove('hidden');
            document.getElementById('ans-input').value = "";
        };

        window.triggerStart = () => {
            db.ref('party/' + me.room).update({ status: 'playing', qIdx: 0 });
        };

        window.triggerNext = () => {
            db.ref('party/' + me.room).once('value', s => {
                let nextIdx = s.val().qIdx + 1;
                if(nextIdx >= s.val().maxQ) { alert("Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø¬ÙŠÙ…!"); location.reload(); return; }
                
                // Ø±ÙŠØ³Øª Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ù„Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯
                for(let p in s.val().players) {
                    db.ref('party/' + me.room + '/players/' + p).update({ submitted: false, lastAns: '' });
                }
                db.ref('party/' + me.room).update({ status: 'playing', qIdx: nextIdx });
            });
        };
    </script>
</body>
</html>
